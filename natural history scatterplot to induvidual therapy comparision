#!/usr/bin/env python3
"""
Natural History vs Monotherapies Validation
Raw scatter + median trend + IQR
Bayley-III Cognitive Function
"""

import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import binned_statistic

np.random.seed(7)

# -----------------------------
# CONFIG
# -----------------------------
DAYS = 365
N = 500
BINS = 20

# -----------------------------
# DATA GENERATION (replace with real data if available)
# -----------------------------
def generate_decline(baseline, slope, noise):
    t = np.random.uniform(0, DAYS, N)
    y = baseline + slope * t + np.random.normal(0, noise, N)
    return t, np.clip(y, 0, 100)

datasets = {
    "Natural History": generate_decline(68, -0.14, 6),
    "SP2 Monotherapy": generate_decline(65, -0.12, 6),
    "AAV Only": generate_decline(70, -0.09, 7),
    "FUS Only": generate_decline(67, -0.14, 6),
}

colors = {
    "Natural History": "#1f77b4",
    "SP2 Monotherapy": "#ff7f0e",
    "AAV Only": "#2ca02c",
    "FUS Only": "#7f7f7f",
}

# -----------------------------
# PLOTTING FUNCTION
# -----------------------------
def plot_condition(ax, t, y, label, color):
    bins = np.linspace(0, DAYS, BINS)

    median, _, _ = binned_statistic(t, y, 'median', bins=bins)
    q25, _, _ = binned_statistic(t, y, lambda v: np.percentile(v, 25), bins=bins)
    q75, _, _ = binned_statistic(t, y, lambda v: np.percentile(v, 75), bins=bins)

    centers = 0.5 * (bins[:-1] + bins[1:])

    ax.scatter(t, y, s=10, alpha=0.25, color=color)
    ax.fill_between(centers, q25, q75, color=color, alpha=0.15)
    ax.plot(centers, median, color=color, lw=2.5, label=label)

# -----------------------------
# FIGURE
# -----------------------------
fig, ax = plt.subplots(figsize=(8.5, 6))

for label, (t, y) in datasets.items():
    plot_condition(ax, t, y, label, colors[label])

ax.set_title("Natural History vs Monotherapy Validation â€“ Cognitive Function")
ax.set_xlabel("Time (days)")
ax.set_ylabel("Bayley-III Cognitive Score")

ax.legend(frameon=False)
ax.grid(alpha=0.25)

plt.tight_layout()
plt.show()
